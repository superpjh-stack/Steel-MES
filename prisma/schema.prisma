generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// UserRole: operator | qc | me | supervisor | manager | admin
// WoStatus: draft | issued | in_progress | completed | cancelled
// EquipStatus: running | stopped | maintenance | breakdown
// InspType: incoming | in_process | outgoing
// DefectDisp: rework | scrap | use_as_is | return
// ShipStatus: planned | packed | shipped | delivered
// MovementType: receipt | issue | return | adjustment | shipment

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String
  passwordHash String    @map("password_hash")
  role         String    // UserRole
  department   String?
  shift        String?
  isActive     Boolean   @default(true) @map("is_active")
  lastLoginAt  DateTime? @map("last_login_at")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  workOrders     WorkOrder[]
  productionLogs ProductionLog[]
  inspections    InspectionRecord[]
  maintenances   MaintenanceRecord[]
  salesOrders    SalesOrder[]
  systemLogs     SystemLog[]

  @@map("users")
}

model Customer {
  id        String   @id @default(uuid())
  code      String   @unique
  name      String
  contact   String?
  otdTarget Float    @default(98) @map("otd_target")
  createdAt DateTime @default(now()) @map("created_at")

  products     Product[]
  workOrders   WorkOrder[]
  shipments    Shipment[]
  salesOrders  SalesOrder[]

  @@map("customers")
}

model Product {
  id             String   @id @default(uuid())
  code           String   @unique
  name           String
  category       String
  unit           String   @default("EA")
  customerId     String   @map("customer_id")
  drawingNo      String?  @map("drawing_no")   // 도면번호 (식품: 레시피번호)
  stdCycleSec    Int?     @map("std_cycle_sec")
  // 식품 전용 필드
  shelfLifeDays  Int?     @map("shelf_life_days")   // 유통기한(일)
  storageTemp    String?  @map("storage_temp")       // 보관온도 (예: "0~5℃", "상온")
  allergenInfo   String?  @map("allergen_info")      // 알레르기 유발물질 (JSON list)
  isHaccp        Boolean  @default(false) @map("is_haccp") // HACCP 적용 품목
  netWeight      Float?   @map("net_weight")          // 내용량 (g 또는 ml)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  customer        Customer          @relation(fields: [customerId], references: [id])
  processes       Process[]
  workOrders      WorkOrder[]
  inventory       Inventory[]
  shipments       Shipment[]
  lots            LotTraceability[]
  salesOrders     SalesOrder[]
  recipes         Recipe[]

  @@map("products")
}

model Equipment {
  id           String    @id @default(uuid())
  code         String    @unique
  name         String
  type         String
  location     String?
  manufacturer String?
  installDate  DateTime? @map("install_date")
  pmCycleDays  Int?      @map("pm_cycle_days")
  lastPmDate   DateTime? @map("last_pm_date")
  status       String    @default("running") // EquipStatus
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  processes       Process[]
  productionLogs  ProductionLog[]
  equipmentLogs   EquipmentLog[]
  maintenances    MaintenanceRecord[]
  spcMeasurements SpcMeasurement[]

  @@map("equipment")
}

model Process {
  id          String   @id @default(uuid())
  code        String   @unique
  name        String
  seq         Int
  productId   String?  @map("product_id")
  equipmentId String?  @map("equipment_id")
  createdAt   DateTime @default(now()) @map("created_at")

  product    Product?   @relation(fields: [productId], references: [id])
  equipment  Equipment? @relation(fields: [equipmentId], references: [id])

  productionLogs  ProductionLog[]
  inspections     InspectionRecord[]
  spcMeasurements SpcMeasurement[]

  @@map("processes")
}

model Material {
  id              String   @id @default(uuid())
  code            String   @unique
  name            String
  unit            String   @default("KG")
  spec            String?
  supplier        String?
  safetyStock     Float    @default(0) @map("safety_stock")
  // 식품 원료 전용 필드
  originCountry   String?  @map("origin_country")  // 원산지
  expiryDays      Int?     @map("expiry_days")      // 원료 유효기간(일)
  storageTemp     String?  @map("storage_temp")     // 보관온도
  allergenFlag    String?  @map("allergen_flag")    // 알레르기 유발물질 여부 (JSON)
  isOrganic       Boolean  @default(false) @map("is_organic") // 유기농 여부
  createdAt       DateTime @default(now()) @map("created_at")

  lots              LotTraceability[]
  inventory         Inventory[]
  recipeIngredients RecipeIngredient[]

  @@map("materials")
}

model WorkOrder {
  id           String    @id @default(uuid())
  woNo         String    @unique @map("wo_no")
  productId    String    @map("product_id")
  customerId   String    @map("customer_id")
  plannedQty   Int       @map("planned_qty")
  producedQty  Int       @default(0) @map("produced_qty")
  defectQty    Int       @default(0) @map("defect_qty")
  status       String    @default("draft") // WoStatus
  plannedStart DateTime  @map("planned_start")
  plannedEnd   DateTime  @map("planned_end")
  actualStart  DateTime? @map("actual_start")
  actualEnd    DateTime? @map("actual_end")
  dueDate      DateTime  @map("due_date")
  priority     Int       @default(5)
  notes        String?
  createdById  String    @map("created_by")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  product   Product  @relation(fields: [productId], references: [id])
  customer  Customer @relation(fields: [customerId], references: [id])
  createdBy User     @relation(fields: [createdById], references: [id])

  productionLogs ProductionLog[]
  inspections    InspectionRecord[]
  lots           LotTraceability[]
  shipments      Shipment[]

  @@map("work_orders")
}

model ProductionLog {
  id           String    @id @default(uuid())
  workOrderId  String    @map("work_order_id")
  processId    String    @map("process_id")
  equipmentId  String    @map("equipment_id")
  operatorId   String    @map("operator_id")
  lotNo        String    @map("lot_no")
  plannedQty   Int       @map("planned_qty")
  goodQty      Int       @map("good_qty")
  defectQty    Int       @default(0) @map("defect_qty")
  scrapQty     Int       @default(0) @map("scrap_qty")
  startTime    DateTime  @map("start_time")
  endTime      DateTime? @map("end_time")
  cycleTimeSec Int?      @map("cycle_time_sec")
  notes        String?
  createdAt    DateTime  @default(now()) @map("created_at")

  workOrder WorkOrder @relation(fields: [workOrderId], references: [id])
  process   Process   @relation(fields: [processId], references: [id])
  equipment Equipment @relation(fields: [equipmentId], references: [id])
  operator  User      @relation(fields: [operatorId], references: [id])

  defects DefectLog[]

  @@map("production_logs")
}

model InspectionRecord {
  id             String   @id @default(uuid())
  type           String   // InspType
  workOrderId    String   @map("work_order_id")
  lotNo          String   @map("lot_no")
  processId      String?  @map("process_id")
  inspectorId    String   @map("inspector_id")
  sampleQty      Int      @map("sample_qty")
  passQty        Int      @map("pass_qty")
  failQty        Int      @map("fail_qty")
  result         String
  inspectionDate DateTime @map("inspection_date")
  notes          String?
  createdAt      DateTime @default(now()) @map("created_at")

  workOrder  WorkOrder  @relation(fields: [workOrderId], references: [id])
  process    Process?   @relation(fields: [processId], references: [id])
  inspector  User       @relation(fields: [inspectorId], references: [id])

  defects DefectLog[]
  ncrs    NonconformanceReport[]

  @@map("inspection_records")
}

model DefectLog {
  id               String   @id @default(uuid())
  productionLogId  String?  @map("production_log_id")
  inspectionId     String?  @map("inspection_id")
  defectCode       String   @map("defect_code")
  defectName       String   @map("defect_name")
  qty              Int
  disposition      String   // DefectDisp
  rootCause        String?  @map("root_cause")
  correctiveAction String?  @map("corrective_action")
  createdById      String   @map("created_by")
  createdAt        DateTime @default(now()) @map("created_at")

  productionLog ProductionLog?    @relation(fields: [productionLogId], references: [id])
  inspection    InspectionRecord? @relation(fields: [inspectionId], references: [id])

  @@map("defect_logs")
}

model SpcMeasurement {
  id             String   @id @default(uuid())
  workOrderId    String   @map("work_order_id")
  processId      String   @map("process_id")
  equipmentId    String?  @map("equipment_id")
  operatorId     String   @map("operator_id")
  characteristic String
  usl            Float
  lsl            Float
  nominal        Float
  measuredValue  Float    @map("measured_value")
  measuredAt     DateTime @map("measured_at")
  subgroupNo     Int      @map("subgroup_no")

  process   Process    @relation(fields: [processId], references: [id])
  equipment Equipment? @relation(fields: [equipmentId], references: [id])

  @@map("spc_measurements")
}

model NonconformanceReport {
  id           String    @id @default(uuid())
  ncrNo        String    @unique @map("ncr_no")
  inspectionId String    @map("inspection_id")
  disposition  String
  approverId   String?   @map("approver_id")
  approvedAt   DateTime? @map("approved_at")
  status       String    @default("open")
  createdAt    DateTime  @default(now()) @map("created_at")

  inspection InspectionRecord @relation(fields: [inspectionId], references: [id])

  @@map("nonconformance_reports")
}

model EquipmentLog {
  id             String   @id @default(uuid())
  equipmentId    String   @map("equipment_id")
  logDate        DateTime @map("log_date")
  shift          String
  plannedTimeMin Int      @map("planned_time_min")
  actualTimeMin  Int      @map("actual_time_min")
  breakdownMin   Int      @default(0) @map("breakdown_min")
  setupMin       Int      @default(0) @map("setup_min")
  plannedQty     Int      @map("planned_qty")
  actualQty      Int      @map("actual_qty")
  goodQty        Int      @map("good_qty")
  createdAt      DateTime @default(now()) @map("created_at")

  equipment Equipment @relation(fields: [equipmentId], references: [id])

  @@map("equipment_logs")
}

model MaintenanceRecord {
  id           String    @id @default(uuid())
  equipmentId  String    @map("equipment_id")
  type         String
  description  String
  technicianId String    @map("technician_id")
  startTime    DateTime  @map("start_time")
  endTime      DateTime? @map("end_time")
  partsUsed    String?   @map("parts_used") // JSON string (SQLite has no Json type)
  cost         Float?
  nextPmDate   DateTime? @map("next_pm_date")
  createdAt    DateTime  @default(now()) @map("created_at")

  equipment  Equipment @relation(fields: [equipmentId], references: [id])
  technician User      @relation(fields: [technicianId], references: [id])

  @@map("maintenance_records")
}

model LotTraceability {
  id          String   @id @default(uuid())
  lotNo       String   @unique @map("lot_no")
  materialId  String?  @map("material_id")
  materialLot String?  @map("material_lot")
  workOrderId String   @map("work_order_id")
  productId   String   @map("product_id")
  qty         Float
  status      String   @default("wip")
  createdAt   DateTime @default(now()) @map("created_at")

  material  Material?  @relation(fields: [materialId], references: [id])
  workOrder WorkOrder  @relation(fields: [workOrderId], references: [id])
  product   Product    @relation(fields: [productId], references: [id])

  @@map("lot_traceability")
}

model Inventory {
  id         String   @id @default(uuid())
  materialId String?  @map("material_id")
  productId  String?  @map("product_id")
  lotNo      String?  @map("lot_no")
  qty        Float
  location   String?
  status     String   @default("available")
  updatedAt  DateTime @updatedAt @map("updated_at")

  material  Material?           @relation(fields: [materialId], references: [id])
  product   Product?            @relation(fields: [productId], references: [id])
  movements InventoryMovement[]

  @@map("inventory")
}

model InventoryMovement {
  id           String   @id @default(uuid())
  inventoryId  String   @map("inventory_id")
  movementType String   @map("movement_type") // MovementType
  qty          Float
  workOrderId  String?  @map("work_order_id")
  referenceNo  String?  @map("reference_no")
  createdById  String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")

  inventory Inventory @relation(fields: [inventoryId], references: [id])

  @@map("inventory_movements")
}

model Shipment {
  id          String    @id @default(uuid())
  shipmentNo  String    @unique @map("shipment_no")
  customerId  String    @map("customer_id")
  workOrderId String    @map("work_order_id")
  productId   String    @map("product_id")
  lotNo       String?   @map("lot_no")
  shippedQty  Int       @map("shipped_qty")
  plannedDate DateTime  @map("planned_date")
  actualDate  DateTime? @map("actual_date")
  status      String    @default("planned") // ShipStatus
  createdById String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")

  customer  Customer  @relation(fields: [customerId], references: [id])
  workOrder WorkOrder @relation(fields: [workOrderId], references: [id])
  product   Product   @relation(fields: [productId], references: [id])

  @@map("shipments")
}

// SoStatus: received | confirmed | in_production | completed | cancelled
model SalesOrder {
  id          String    @id @default(uuid())
  soNo        String    @unique @map("so_no")
  customerId  String    @map("customer_id")
  productId   String    @map("product_id")
  orderedQty  Int       @map("ordered_qty")
  dueDate     DateTime  @map("due_date")
  status      String    @default("received") // SoStatus
  notes       String?
  createdById String    @map("created_by")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  customer  Customer @relation(fields: [customerId], references: [id])
  product   Product  @relation(fields: [productId], references: [id])
  createdBy User     @relation(fields: [createdById], references: [id])

  requirements      CustomerRequirement[]
  contractDocuments ContractDocument[]

  @@map("sales_orders")
}

// CommonCode groupCode examples: UNIT, MATERIAL_TYPE, PROCESS_TYPE, etc.
model CommonCode {
  id          String   @id @default(uuid())
  groupCode   String   @map("group_code")
  groupName   String   @map("group_name")
  code        String
  codeName    String   @map("code_name")
  sortOrder   Int      @default(0) @map("sort_order")
  isActive    Boolean  @default(true) @map("is_active")
  description String?
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([groupCode, code])
  @@map("common_codes")
}

// SystemLogAction: LOGIN | LOGOUT | CREATE | UPDATE | DELETE
model SystemLog {
  id        String   @id @default(uuid())
  userId    String?  @map("user_id")
  userName  String?  @map("user_name")
  action    String                       // SystemLogAction
  resource  String?                      // 대상 리소스 (예: User, WorkOrder)
  detail    String?                      // 상세 내용
  ipAddress String?  @map("ip_address")
  createdAt DateTime @default(now()) @map("created_at")

  user User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("system_logs")
}

// InterfaceDevType: barcode_reader | plc | scale | rfid | sensor | other
// InterfaceProto:   tcp | serial | modbus | opc_ua | http | mqtt
model InterfaceDevice {
  id          String    @id @default(uuid())
  name        String
  devType     String    @map("dev_type")   // InterfaceDevType
  protocol    String                        // InterfaceProto
  host        String?
  port        Int?
  description String?
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  @@map("interface_devices")
}

// 고객요구사항: 점도·압력·진공·부식성 등 고객 공정 조건
model CustomerRequirement {
  id           String   @id @default(uuid())
  salesOrderId String   @map("sales_order_id")
  category     String   // viscosity | pressure | vacuum | corrosion | temperature | other
  item         String   // 요구 항목명
  value        String   // 요구 값
  unit         String?  // 단위 (예: bar, ℃, mPa·s)
  notes        String?
  createdById  String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id])

  @@map("customer_requirements")
}

// 견적/계약 문서 첨부
model ContractDocument {
  id           String   @id @default(uuid())
  salesOrderId String   @map("sales_order_id")
  docType      String   // quotation | contract | po | amendment | other
  fileName     String   @map("file_name")
  fileUrl      String   @map("file_url")   // 실제 환경에서는 파일 서버 경로
  fileSize     Int?     @map("file_size")  // bytes
  notes        String?
  createdById  String   @map("created_by")
  createdAt    DateTime @default(now()) @map("created_at")

  salesOrder SalesOrder @relation(fields: [salesOrderId], references: [id])

  @@map("contract_documents")
}

// Sequential ID counter — prevents race conditions in WO/NCR/SHP number generation
model Sequence {
  prefix     String @id
  currentVal Int    @default(0) @map("current_val")
  lastDate   String @map("last_date")

  @@map("sequences")
}

// ─── 식품 전용 모델 ────────────────────────────────────────────────────────────

// 배합비 (레시피/BOM) — 제품별 원료 구성
// RecipeStatus: draft | approved | obsolete
model Recipe {
  id          String   @id @default(uuid())
  productId   String   @map("product_id")
  version     String   @default("1.0")     // 버전 관리
  batchSizeKg Float    @map("batch_size_kg") // 배치 생산량 (kg)
  status      String   @default("draft")   // RecipeStatus
  approvedById String? @map("approved_by")
  approvedAt  DateTime? @map("approved_at")
  notes       String?
  createdById String   @map("created_by")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  product     Product            @relation(fields: [productId], references: [id])
  ingredients RecipeIngredient[]

  @@map("recipes")
}

// 배합비 원료 상세
model RecipeIngredient {
  id         String  @id @default(uuid())
  recipeId   String  @map("recipe_id")
  materialId String  @map("material_id")
  ratio      Float                       // 배합 비율 (%)
  amountKg   Float   @map("amount_kg")  // 배치당 투입량 (kg)
  sortOrder  Int     @default(0) @map("sort_order")
  notes      String?

  recipe   Recipe   @relation(fields: [recipeId], references: [id])
  material Material @relation(fields: [materialId], references: [id])

  @@map("recipe_ingredients")
}

// HACCP 계획 — 위해요소 중요관리점 계획
// HaccpStatus: active | under_review | suspended
model HaccpPlan {
  id            String   @id @default(uuid())
  productId     String?  @map("product_id")   // null이면 공장 전체 적용
  processCode   String?  @map("process_code") // 대상 공정
  ccpNo         String   @unique @map("ccp_no") // CCP 번호 (예: CCP-1, CCP-2)
  hazardType    String   @map("hazard_type")  // biological | chemical | physical
  hazardDesc    String   @map("hazard_desc")  // 위해요소 설명
  criticalLimit String   @map("critical_limit") // 한계기준 (예: "85℃ 이상/30분")
  monitoringFreq String  @map("monitoring_freq") // 모니터링 주기
  correctiveAction String @map("corrective_action") // 개선조치
  verifyMethod  String?  @map("verify_method")
  status        String   @default("active")   // HaccpStatus
  effectiveDate DateTime @map("effective_date")
  createdById   String   @map("created_by")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  monitoringLogs CcpMonitoring[]

  @@map("haccp_plans")
}

// CCP 모니터링 — 실시간 한계기준 모니터링 기록
// CcpResult: pass | fail | deviation
model CcpMonitoring {
  id            String   @id @default(uuid())
  haccpPlanId   String   @map("haccp_plan_id")
  workOrderId   String?  @map("work_order_id")
  lotNo         String?  @map("lot_no")
  monitoredAt   DateTime @map("monitored_at")
  measuredValue String   @map("measured_value") // 실측값
  result        String                           // CcpResult
  deviationNote String?  @map("deviation_note") // 이탈 시 조치내용
  operatorId    String   @map("operator_id")
  createdAt     DateTime @default(now()) @map("created_at")

  haccpPlan HaccpPlan @relation(fields: [haccpPlanId], references: [id])

  @@map("ccp_monitoring")
}

// 위생점검 관리
// HygieneArea: production | storage | restroom | equipment | personnel
// HygieneResult: pass | fail | conditional_pass
model HygieneCheck {
  id            String   @id @default(uuid())
  checkDate     DateTime @map("check_date")
  shift         String                          // 1st | 2nd | 3rd
  area          String                          // HygieneArea
  checkedById   String   @map("checked_by")
  items         String   @map("items")          // JSON: 점검 항목별 결과
  result        String                          // HygieneResult
  failItems     String?  @map("fail_items")     // 불합격 항목
  correctiveAction String? @map("corrective_action")
  notes         String?
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("hygiene_checks")
}

// 이물검출 관리
// ForeignBodyType: metal | glass | rubber | plastic | hair | insect | other
// ForeignBodyDisp: recall | rework | scrap | use_as_is
model ForeignBodyReport {
  id             String   @id @default(uuid())
  reportNo       String   @unique @map("report_no")
  detectedAt     DateTime @map("detected_at")
  lotNo          String?  @map("lot_no")
  productId      String?  @map("product_id")
  detectionPoint String   @map("detection_point") // 검출 지점 (금속검출기, X-RAY, 육안 등)
  foreignType    String   @map("foreign_type")     // ForeignBodyType
  size           String?                           // 크기 (mm)
  disposition    String                            // ForeignBodyDisp
  rootCause      String?  @map("root_cause")
  correctiveAction String? @map("corrective_action")
  affectedQty    Int      @default(0) @map("affected_qty")
  reportedById   String   @map("reported_by")
  status         String   @default("open")         // open | closed
  createdAt      DateTime @default(now()) @map("created_at")

  @@map("foreign_body_reports")
}

// 알레르기 코드 마스터 (식품위생법 21종)
model AllergenCode {
  id       String  @id @default(uuid())
  code     String  @unique
  name     String                     // 알레르기 유발 식품명
  nameEn   String? @map("name_en")   // 영문명 (수출용)
  isActive Boolean @default(true) @map("is_active")

  @@map("allergen_codes")
}
